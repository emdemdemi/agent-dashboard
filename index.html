<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü§ñ Agent Dashboard - LIVE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --accent-primary: #238636;
    --accent-secondary: #1f6feb;
    --accent-danger: #da3633;
    --accent-warning: #d29922;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --border-color: #30363d;
}
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
}
.dashboard-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
}
.header-left h1 { font-size: 1.1rem; font-weight: 600; }
.connection-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    padding: 4px 10px;
    background: var(--bg-tertiary);
    border-radius: 20px;
}
.connection-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent-warning);
}
.connection-dot.connected { background: var(--accent-primary); box-shadow: 0 0 8px var(--accent-primary); }
.connection-dot.error { background: var(--accent-danger); }
.btn { padding: 8px 14px; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; }
.btn-refresh { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
.dashboard-main { padding: 16px; display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 1400px; margin: 0 auto; }
@media (min-width: 768px) { .dashboard-main { grid-template-columns: repeat(2, 1fr); } }
.panel { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
.panel-header { padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
.panel-header h2 { font-size: 0.95rem; font-weight: 600; }
.token-display { padding: 20px; }
.token-metric { display: flex; align-items: baseline; gap: 8px; margin-bottom: 16px; }
.metric-value { font-size: 2rem; font-weight: 700; color: var(--accent-primary); }
.metric-label { color: var(--text-secondary); font-size: 0.9rem; }
.token-bar-container { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
.token-bar { flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; }
.token-bar-fill { height: 100%; background: var(--accent-primary); border-radius: 4px; transition: width 0.5s ease; }
.status-panel { padding: 20px; text-align: center; }
.status-indicator-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    background: var(--bg-tertiary);
    border: 3px solid var(--text-muted);
}
.status-indicator-large.online { 
    border-color: var(--text-muted); 
    background: var(--bg-tertiary);
}
@keyframes pulse-green {
    0%, 100% { box-shadow: 0 0 0 0 rgba(35, 134, 54, 0.4); }
    50% { box-shadow: 0 0 0 15px rgba(35, 134, 54, 0); }
}
.status-indicator-large.working { 
    border-color: var(--accent-primary); 
    background: rgba(35, 134, 54, 0.1);
    animation: pulse-green 2s infinite;
}
@keyframes pulse-blue {
    0%, 100% { box-shadow: 0 0 0 0 rgba(31, 111, 235, 0.4); }
    50% { box-shadow: 0 0 0 15px rgba(31, 111, 235, 0); }
}
.current-task { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
.last-updated { font-size: 0.75rem; color: var(--text-muted); }
.kanban-board { display: flex; gap: 12px; padding: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
.kanban-column { min-width: 260px; flex: 1; background: var(--bg-tertiary); border-radius: 8px; max-height: 500px; }
.column-header { padding: 12px; display: flex; align-items: center; justify-content: space-between; font-weight: 600; font-size: 0.85rem; border-bottom: 1px solid var(--border-color); }
.count { background: var(--bg-secondary); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: var(--text-secondary); }
.column-cards { padding: 10px; display: flex; flex-direction: column; gap: 8px; min-height: 100px; }
.task-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; }
.task-priority { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 700; margin-bottom: 6px; display: inline-block; }
.priority-high { background: rgba(218, 54, 51, 0.2); color: var(--accent-danger); }
.priority-medium { background: rgba(210, 153, 34, 0.2); color: var(--accent-warning); }
.priority-low { background: rgba(35, 134, 54, 0.2); color: var(--accent-primary); }
.task-title { font-size: 0.85rem; font-weight: 500; }
.task-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; display: flex; gap: 12px; }
.log-container { padding: 16px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.75rem; }
.log-entry { padding: 6px 0; border-bottom: 1px solid var(--border-color); display: flex; gap: 12px; }
.timestamp { color: var(--text-muted); min-width: 60px; }
.message { color: var(--text-secondary); }
.empty-state { text-align: center; padding: 40px; color: var(--text-muted); font-size: 0.85rem; }
.setup-instructions { 
    background: var(--bg-tertiary); 
    padding: 16px; 
    border-radius: 8px; 
    margin: 16px;
    font-size: 0.85rem;
    line-height: 1.6;
}
.setup-instructions code {
    background: var(--bg-secondary);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.75rem;
}
.setup-instructions ol { margin-left: 20px; margin-top: 12px; }
.setup-instructions li { margin-bottom: 8px; }
</style>
</head>
<body>
    <div id="app">
        <header class="dashboard-header">
            <div class="header-left">
                <h1>ü§ñ Agent Dashboard</h1>
            </div>
            <div class="header-center" style="display: flex; gap: 12px;">
                <div class="connection-status" id="connectionStatus">
                    <span class="connection-dot" id="connectionDot"></span>
                    <span id="connectionText">Connecting...</span>
                </div>
                <span class="last-updated" id="lastSync">--:--:--</span>
            </div>
            <div class="header-right">
                <button class="btn btn-refresh" onclick="location.reload()">üîÑ Refresh</button>
            </div>
        </header>

        <main class="dashboard-main">
            <section class="panel status-panel" style="grid-column: 1 / -1;">
                <div class="status-indicator-large online" id="statusIndicator">ü§ñ</div>
                <div class="current-task" id="currentTask">Initializing...</div>
                <div class="last-updated" id="lastUpdated">Waiting for data...</div>
            </section>

            <section class="panel token-panel">
                <div class="panel-header"><h2>üìä Token Usage</h2></div>
                <div class="token-display">
                    <div class="token-metric">
                        <span class="metric-value" id="dailyTokens">--</span>
                        <span class="metric-label">/ 100K daily</span>
                    </div>
                    <div class="token-bar-container">
                        <div class="token-bar"><div class="token-bar-fill" id="dailyBar" style="width: 0%"></div></div>
                    </div>
                    <div style="margin-top: 16px; font-size: 0.85rem; color: var(--text-secondary);">
                        Session: <span id="sessionTokens" style="color: var(--text-primary); font-weight: 600;">--</span> tokens
                    </div>
                </div>
            </section>

            <section class="panel kanban-panel" style="grid-column: 1 / -1;">
                <div class="panel-header"><h2>üìã Task Board</h2></div>
                <div class="kanban-board" id="kanbanBoard">
                    <div class="kanban-column"><div class="column-header"><span>üì• Backlog</span><span class="count" id="count-backlog">0</span></div><div class="column-cards" id="col-backlog"></div></div>
                    <div class="kanban-column"><div class="column-header"><span>üìù To Do</span><span class="count" id="count-todo">0</span></div><div class="column-cards" id="col-todo"></div></div>
                    <div class="kanban-column"><div class="column-header"><span>‚ñ∂Ô∏è In Progress</span><span class="count" id="count-inprogress">0</span></div><div class="column-cards" id="col-inprogress"></div></div>
                    <div class="kanban-column"><div class="column-header"><span>üëÄ Review</span><span class="count" id="count-review">0</span></div><div class="column-cards" id="col-review"></div></div>
                    <div class="kanban-column"><div class="column-header"><span>‚úÖ Done</span><span class="count" id="count-done">0</span></div><div class="column-cards" id="col-done"></div></div>
                </div>
            </section>

            <section class="panel log-panel" style="grid-column: 1 / -1;">
                <div class="panel-header"><h2>üìù Activity Log</h2></div>
                <div class="log-container" id="activityLog">
                    <div class="empty-state">Waiting for connection to Supabase...</div>
                </div>
            </section>

            <section id="setupSection" style="grid-column: 1 / -1;">
                <div class="setup-instructions">
                    <strong>‚ö†Ô∏è Supabase Setup Required</strong><br><br>
                    The dashboard is connected but needs the database tables created. Run this SQL in your Supabase SQL Editor:
                    <ol>
                        <li>Go to <a href="https://app.supabase.com/project/altmxznbmxidqirlarwh/editor" target="_blank" style="color: var(--accent-primary);">Supabase SQL Editor</a></li>
                        <li>Click "New Query"</li>
                        <li>Paste the SQL from <code>setup.sql</code> file</li>
                        <li>Click "Run"</li>
                    </ol>
                    The dashboard will automatically populate with live data once tables exist.
                </div>
            </section>
        </main>
    </div>

<script>
const SUPABASE_URL = 'https://altmxznbmxidqirlarwh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsdG14em5ibXhpZHFpcmxhcndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzgxNTksImV4cCI6MjA4NTcxNDE1OX0.Sgl81tgqHI8S3ZzqbJYBa9jAl70HPa5b5_sCoGpDUJY';

class LiveDashboard {
    constructor() {
        this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        this.data = { status: null, tasks: [], activities: [] };
        this.init();
    }

    async init() {
        this.updateConnection('connecting');
        
        // Initial load
        await this.loadData();
        
        // Subscribe to realtime changes
        this.subscribeToChanges();
        
        // Poll every 30 seconds as backup
        setInterval(() => this.loadData(), 30000);
    }

    updateConnection(status) {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        const lastSync = document.getElementById('lastSync');
        
        dot.className = 'connection-dot ' + status;
        text.textContent = status === 'connected' ? 'Live' : status === 'connecting' ? 'Connecting...' : 'Error';
        lastSync.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    async loadData() {
        try {
            // Load status
            const { data: status, error: statusError } = await this.supabase
                .from('agent_status')
                .select('*')
                .eq('id', 1)
                .single();

            if (statusError && statusError.code !== 'PGRST116') {
                console.log('Status table not ready yet');
                this.showSetup();
                return;
            }

            if (status) {
                this.data.status = status;
                this.updateConnection('connected');
                document.getElementById('setupSection').style.display = 'none';
            }

            // Load tasks
            const { data: tasks } = await this.supabase
                .from('agent_tasks')
                .select('*')
                .order('created_at', { ascending: false });

            if (tasks) this.data.tasks = tasks;

            // Load activities
            const { data: activities } = await this.supabase
                .from('agent_activities')
                .select('*')
                .order('id', { ascending: false })
                .limit(20);

            if (activities) this.data.activities = activities;

            this.render();

        } catch (e) {
            console.error('Load error:', e);
            this.updateConnection('error');
        }
    }

    subscribeToChanges() {
        // Subscribe to agent status changes
        this.supabase
            .channel('agent-status')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'agent_status' }, payload => {
                console.log('Status change:', payload);
                this.data.status = payload.new;
                this.render();
            })
            .subscribe();

        // Subscribe to task changes
        this.supabase
            .channel('agent-tasks')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'agent_tasks' }, payload => {
                console.log('Task change:', payload);
                this.loadData();
            })
            .subscribe();

        // Subscribe to activity changes
        this.supabase
            .channel('agent-activities')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'agent_activities' }, payload => {
                console.log('New activity:', payload);
                this.data.activities.unshift(payload.new);
                this.renderLog();
            })
            .subscribe();
    }

    render() {
        this.renderStatus();
        this.renderTokens();
        this.renderKanban();
        this.renderLog();
    }

    renderStatus() {
        if (!this.data.status) return;
        
        const indicator = document.getElementById('statusIndicator');
        const task = document.getElementById('currentTask');
        const updated = document.getElementById('lastUpdated');

        // Update status indicator
        indicator.className = 'status-indicator-large';
        if (this.data.status.status === 'online') {
            indicator.classList.add('online');
            indicator.textContent = 'ü§ñ';
        } else if (this.data.status.status === 'working') {
            indicator.classList.add('working');
            indicator.textContent = '‚ö°';
        }

        // Update current task
        task.textContent = this.data.status.current_task || 'Idle';
        
        // Update timestamp
        const date = new Date(this.data.status.updated_at);
        updated.textContent = 'Last update: ' + date.toLocaleTimeString();
    }

    renderTokens() {
        if (!this.data.status) return;

        const daily = this.data.status.tokens_daily || 0;
        const limit = 100000;
        const percent = Math.min((daily / limit) * 100, 100);

        document.getElementById('dailyTokens').textContent = (daily / 1000).toFixed(1) + 'K';
        document.getElementById('dailyBar').style.width = percent + '%';
        document.getElementById('sessionTokens').textContent = (this.data.status.tokens_session || 0).toLocaleString();
    }

    renderKanban() {
        const columns = { backlog: [], todo: [], inprogress: [], review: [], done: [] };
        
        this.data.tasks.forEach(task => {
            const status = (task.task_status || 'backlog').toLowerCase().replace('-', '');
            if (columns[status]) columns[status].push(task);
        });

        Object.entries(columns).forEach(([col, tasks]) => {
            const container = document.getElementById('col-' + col);
            const count = document.getElementById('count-' + col);
            
            if (container && count) {
                count.textContent = tasks.length;
                container.innerHTML = tasks.map(t => `
                    <div class="task-card">
                        <span class="task-priority priority-${t.task_priority}">${t.task_priority}</span>
                        <div class="task-title">${t.task_title}</div>
                        <div class="task-meta">
                            <span>‚ö° ${(t.task_tokens / 1000).toFixed(1)}K</span>
                            <span>${t.task_status}</span>
                        </div>
                    </div>
                `).join('');
            }
        });
    }

    renderLog() {
        const container = document.getElementById('activityLog');
        
        if (!this.data.activities || this.data.activities.length === 0) {
            container.innerHTML = '<div class="empty-state">No activity yet</div>';
            return;
        }

        container.innerHTML = this.data.activities.map(a => `
            <div class="log-entry">
                <span class="timestamp">${a.activity_time || '--:--'}</span>
                <span class="message">${a.activity_message}</span>
            </div>
        `).join('');
    }

    showSetup() {
        document.getElementById('setupSection').style.display = 'block';
        document.getElementById('activityLog').innerHTML = '<div class="empty-state">Supabase tables not created yet. See setup instructions below.</div>';
    }

    manualRefresh() {
        this.loadData();
        this.updateConnection('connected');
    }

    async updateMyStatus(status, task) {
        const { error } = await this.supabase
            .from('agent_status')
            .upsert({ 
                id: 1, 
                status: status, 
                current_task: task, 
                updated_at: new Date().toISOString() 
            });
        if (error) console.error('Update error:', error);
    }

    async logActivity(message, type = 'info') {
        const { error } = await this.supabase
            .from('agent_activities')
            .insert({
                activity_time: new Date().toLocaleTimeString(),
                activity_message: message,
                type: type,
                agent_status_id: 1
            });
        if (error) console.error('Log error:', error);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    window.dashboard = new LiveDashboard();
});
</script>
</body>
</html>
