<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü§ñ Agent Dashboard - LIVE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
:root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --accent-primary: #238636;
    --accent-secondary: #1f6feb;
    --accent-danger: #da3633;
    --accent-warning: #d29922;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --border-color: #30363d;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
}
.dashboard-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-color);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.header-center { display: flex; align-items: center; gap: 12px; }
.connection-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    padding: 4px 10px;
    background: var(--bg-tertiary);
    border-radius: 20px;
}
.connection-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-warning); }
.connection-dot.live { background: var(--accent-primary); animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.spinner { width: 14px; height: 14px; border: 2px solid var(--text-muted); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.btn {
    padding: 8px 14px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
}
.dashboard-main { padding: 16px; display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 1200px; margin: 0 auto; }
.panel { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
.panel-header { padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
.panel-body { padding: 20px; }
.status-section { text-align: center; padding: 30px; }
.status-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    margin: 0 auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    background: var(--bg-tertiary);
    border: 4px solid var(--text-muted);
    transition: all 0.3s ease;
}
.status-circle.idle { border-color: var(--text-muted); }
.status-circle.working { 
    border-color: var(--accent-primary); 
    box-shadow: 0 0 30px rgba(35,134,54,0.3);
    animation: pulse-green 2s infinite;
}
@keyframes pulse-green {
    0%, 100% { box-shadow: 0 0 0 0 rgba(35,134,54,0.4); }
    50% { box-shadow: 0 0 0 20px rgba(35,134,54,0); }
}
.status-text { font-size: 1.4rem; font-weight: 600; margin-bottom: 8px; }
.status-time { font-size: 0.85rem; color: var(--text-muted); }
.token-section { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
.token-box { text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; }
.token-value { font-size: 1.8rem; font-weight: 700; color: var(--accent-primary); }
.token-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }
.token-bar-wrap { display: flex; align-items: center; gap: 12px; }
.token-bar { flex: 1; height: 10px; background: var(--bg-tertiary); border-radius: 5px; }
.token-bar-inner { height: 100%; background: var(--accent-primary); border-radius: 5px; transition: width 0.5s ease; }
.kanban-board { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
.kanban-column { min-width: 240px; flex: 1; background: var(--bg-tertiary); border-radius: 8px; }
.column-header { padding: 12px; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 0.85rem; display: flex; justify-content: space-between; }
.count { background: var(--bg-secondary); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
.column-cards { padding: 10px; min-height: 100px; }
.task-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: pointer; }
.task-card:hover { border-color: var(--accent-primary); }
.task-priority { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 700; }
.high { background: rgba(218,54,51,0.2); color: var(--accent-danger); }
.medium { background: rgba(210,153,34,0.2); color: var(--accent-warning); }
.low { background: rgba(35,134,54,0.2); color: var(--accent-primary); }
.task-title { font-size: 0.9rem; margin: 8px 0; }
.task-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 12px; }
.log-list { max-height: 300px; overflow-y: auto; }
.log-item { padding: 10px 0; border-bottom: 1px solid var(--border-color); display: flex; gap: 12px; font-size: 0.8rem; }
.log-item:last-child { border-bottom: none; }
.log-time { color: var(--text-muted); min-width: 60px; }
.log-msg { color: var(--text-secondary); flex: 1; }
.empty { text-align: center; padding: 40px; color: var(--text-muted); }
.last-sync { font-size: 0.75rem; color: var(--text-muted); }
    </style>
</head>
<body>
    <div id="app">
        <header class="dashboard-header">
            <div class="header-left">
                <h1>ü§ñ Agent Dashboard</h1>
            </div>
            <div class="header-center">
                <div class="connection-badge" id="connectionBadge">
                    <span class="connection-dot" id="connDot"></span>
                    <span id="connText">Connecting...</span>
                </div>
                <span class="last-sync" id="lastSync">--:--:--</span>
            </div>
            <button class="btn" id="refreshBtn" onclick="dashboard.forceRefresh()">üîÑ Refresh</button>
        </header>

        <main class="dashboard-main">
            <!-- LIVE STATUS -->
            <section class="panel" style="grid-column: 1 / -1;">
                <div class="panel-body">
                    <div class="status-section">
                        <div class="status-circle idle" id="statusCircle">ü§ñ</div>
                        <div class="status-text" id="currentTask">Loading...</div>
                        <div class="status-time" id="statusTime">Connecting to Supabase...</div>
                    </div>
                </div>
            </section>

            <!-- TOKEN USAGE -->
            <section class="panel">
                <div class="panel-header"><h2>üí∞ Today's Usage</h2></div>
                <div class="panel-body">
                    <div class="token-box" style="grid-column: 1 / -1;">
                        <div class="token-value" id="dailyTokens">--</div>
                        <div class="token-label">Tokens Used Today</div>
                    </div>
                    <div class="token-bar-wrap">
                        <div class="token-bar"><div class="token-bar-inner" id="tokenBar" style="width:0%"></div></div>
                        <span id="tokenPercent" style="font-size:0.8rem;color:var(--text-muted)">0%</span>
                    </div>
                    <div style="margin-top:16px;font-size:0.85rem;color:var(--text-secondary)">
                        Session: <strong id="sessionTokens" style="color:var(--text-primary)">--</strong> tokens
                    </div>
                </div>
            </section>

            <!-- TASK BOARD -->
            <section class="panel" style="grid-column: 1 / -1;">
                <div class="panel-header"><h2>üìã Tasks</h2></div>
                <div class="panel-body">
                    <div class="kanban-board" id="kanban">
                        <div class="kanban-column">
                            <div class="column-header">üì• Backlog <span class="count" id="count-backlog">0</span></div>
                            <div class="column-cards" id="col-backlog"></div>
                        </div>
                        <div class="kanban-column">
                            <div class="column-header">üìù To Do <span class="count" id="count-todo">0</span></div>
                            <div class="column-cards" id="col-todo"></div>
                        </div>
                        <div class="kanban-column">
                            <div class="column-header">‚ñ∂Ô∏è In Progress <span class="count" id="count-inprogress">0</span></div>
                            <div class="column-cards" id="col-inprogress"></div>
                        </div>
                        <div class="kanban-column">
                            <div class="column-header">üëÄ Review <span class="count" id="count-review">0</span></div>
                            <div class="column-cards" id="col-review"></div>
                        </div>
                        <div class="kanban-column">
                            <div class="column-header">‚úÖ Done <span class="count" id="count-done">0</span></div>
                            <div class="column-cards" id="col-done"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ACTIVITY LOG -->
            <section class="panel" style="grid-column: 1 / -1;">
                <div class="panel-header"><h2>üìù Activity Log</h2></div>
                <div class="panel-body">
                    <div class="log-list" id="logList">
                        <div class="empty">Waiting for data...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
const SUPABASE_URL = 'https://altmxznbmxidqirlarwh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsdG14em5ibXhpZHFpcmxhcndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzgxNTksImV4cCI6MjA4NTcxNDE1OX0.Sgl81tgqHI8S3ZzqbJYBa9jAl70HPa5b5_sCoGpDUJY';

class Dashboard {
    constructor() {
        this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        this.data = {};
        this.isLoading = false;
        this.init();
    }

    init() {
        this.setStatus('loading');
        this.loadAll();
        // Auto-refresh every 5 seconds for truly live feel
        setInterval(() => this.loadAll(), 5000);
    }

    setStatus(state) {
        const dot = document.getElementById('connDot');
        const text = document.getElementById('connText');
        const btn = document.getElementById('refreshBtn');
        
        dot.className = 'connection-dot' + (state === 'live' ? ' live' : '');
        text.textContent = state === 'loading' ? 'Loading...' : state === 'live' ? 'Live' : 'Error';
        btn.innerHTML = state === 'loading' ? '<div class="spinner"></div>' : 'üîÑ Refresh';
    }

    async loadAll() {
        if (this.isLoading) return;
        this.isLoading = true;
        this.setStatus('loading');
        
        try {
            // Load status
            const { data: status } = await this.supabase.from('agent_status').select('*').eq('id', 1).single();
            if (status) this.data.status = status;
            
            // Load tasks
            const { data: tasks } = await this.supabase.from('agent_tasks').select('*').order('created_at', { ascending: false });
            if (tasks) this.data.tasks = tasks;
            
            // Load activities
            const { data: logs } = await this.supabase.from('agent_activities').select('*').order('id', { ascending: false }).limit(20);
            if (logs) this.data.logs = logs;
            
            this.render();
            this.setStatus('live');
            document.getElementById('lastSync').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        } catch (e) {
            console.error('Load error:', e);
            this.setStatus('error');
        }
        
        this.isLoading = false;
    }

    forceRefresh() {
        this.loadAll();
    }

    render() {
        this.renderStatus();
        this.renderTokens();
        this.renderTasks();
        this.renderLogs();
    }

    renderStatus() {
        if (!this.data.status) return;
        
        const circle = document.getElementById('statusCircle');
        const task = document.getElementById('currentTask');
        const time = document.getElementById('statusTime');
        
        const status = this.data.status.status || 'online';
        const isWorking = status === 'working';
        
        circle.className = 'status-circle' + (isWorking ? ' working' : ' idle');
        circle.textContent = isWorking ? '‚ö°' : 'ü§ñ';
        
        task.textContent = this.data.status.current_task || 'Idle';
        task.style.color = isWorking ? 'var(--accent-primary)' : 'var(--text-primary)';
        
        const updated = new Date(this.data.status.updated_at || Date.now());
        time.textContent = 'Updated: ' + updated.toLocaleTimeString();
    }

    renderTokens() {
        if (!this.data.status) return;
        
        const daily = this.data.status.tokens_daily || 0;
        const limit = 100000;
        const session = this.data.status.tokens_session || 0;
        const percent = Math.min((daily / limit) * 100, 100);
        
        document.getElementById('dailyTokens').textContent = this.formatNumber(daily);
        document.getElementById('sessionTokens').textContent = this.formatNumber(session);
        document.getElementById('tokenBar').style.width = percent + '%';
        document.getElementById('tokenPercent').textContent = percent.toFixed(1) + '%';
    }

    renderTasks() {
        if (!this.data.tasks) return;
        
        const cols = { backlog: [], todo: [], inprogress: [], review: [], done: [] };
        
        this.data.tasks.forEach(t => {
            const key = (t.task_status || 'backlog').replace('-', '');
            if (cols[key]) cols[key].push(t);
        });
        
        Object.entries(cols).forEach(([col, tasks]) => {
            const container = document.getElementById('col-' + col);
            const count = document.getElementById('count-' + col);
            
            if (container && count) {
                count.textContent = tasks.length;
                if (tasks.length === 0) {
                    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:0.8rem">No tasks</div>';
                } else {
                    container.innerHTML = tasks.map(t => `
                        <div class="task-card" onclick="dashboard.changeStatus('${t.id}')">
                            <span class="task-priority ${t.task_priority}">${t.task_priority}</span>
                            <div class="task-title">${this.escapeHtml(t.task_title)}</div>
                            <div class="task-meta">
                                <span>‚ö° ${this.formatNumber(t.task_tokens)} tokens</span>
                            </div>
                        </div>
                    `).join('');
                }
            }
        });
    }

    renderLogs() {
        const container = document.getElementById('logList');
        
        if (!this.data.logs || this.data.logs.length === 0) {
            container.innerHTML = '<div class="empty">No activity yet</div>';
            return;
        }
        
        container.innerHTML = this.data.logs.map(l => `
            <div class="log-item">
                <span class="log-time">${l.activity_time || '--:--'}</span>
                <span class="log-msg">${this.escapeHtml(l.activity_message)}</span>
            </div>
        `).join('');
    }

    async changeStatus(taskId) {
        const statuses = ['backlog', 'todo', 'in-progress', 'review', 'done'];
        const task = this.data.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        const current = statuses.indexOf(task.task_status);
        const next = statuses[(current + 1) % statuses.length];
        
        try {
            await this.supabase.from('agent_tasks').update({ task_status: next }).eq('id', taskId);
            this.loadAll();
        } catch (e) {
            console.error('Status update failed:', e);
        }
    }

    formatNumber(num) {
        if (!num) return '0';
        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// Start
document.addEventListener('DOMContentLoaded', () => {
    window.dashboard = new Dashboard();
});
</script>
</body>
</html>
