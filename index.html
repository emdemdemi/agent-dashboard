<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agent Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --bg-hover: #262c36;
    --border: #30363d;
    --text: #f0f6fc;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --accent: #238636;
    --accent-glow: rgba(35,134,54,0.4);
    --warning: #d29922;
    --danger: #da3633;
    --purple: #a371f7;
    --blue: #58a6ff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg-primary);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}
.container { max-width: 1400px; margin: 0 auto; padding: 16px; }

/* Header */
.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
}
.header-left { display: flex; align-items: center; gap: 12px; }
.logo {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--purple), var(--blue));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px;
}
.header-title { font-size: 20px; font-weight: 600; }
.live-badge {
    display: flex; align-items: center; gap: 6px;
    font-size: 12px; color: var(--accent);
    background: rgba(35,134,54,0.1);
    padding: 6px 12px; border-radius: 20px;
}
.live-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* Status Panel */
.status-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
}
@media (max-width: 640px) { .status-grid { grid-template-columns: 1fr; } }

.status-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
}
.status-main {
    display: flex;
    align-items: center;
    gap: 16px;
}
.status-circle {
    width: 60px; height: 60px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px;
    background: var(--bg-tertiary);
    border: 3px solid var(--text-muted);
    transition: all 0.3s;
}
.status-circle.working {
    border-color: var(--accent);
    box-shadow: 0 0 30px var(--accent-glow);
    animation: glow 2s infinite;
}
@keyframes glow { 0%,100%{box-shadow:0 0 0 0 var(--accent-glow)} 50%{box-shadow:0 0 20px 5px var(--accent-glow)} }

.status-info { flex: 1; }
.status-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.status-task { font-size: 16px; font-weight: 500; margin-top: 4px; line-height: 1.4; }

.token-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 16px;
}
.token-box { text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; }
.token-value { font-size: 20px; font-weight: 700; color: var(--accent); }
.token-label { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

/* Kanban */
.kanban-section { margin-bottom: 24px; }
.section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px;
}
.section-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }

.kanban-board {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 8px;
    -webkit-overflow-scrolling: touch;
}
.kanban-column {
    min-width: 260px;
    flex: 1;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 10px;
    max-height: 500px;
    display: flex;
    flex-direction: column;
}
.column-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    font-weight: 600;
    display: flex; justify-content: space-between; align-items: center;
}
.column-count {
    background: var(--bg-tertiary);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    color: var(--text-secondary);
}
.column-cards {
    padding: 12px;
    overflow-y: auto;
    flex: 1;
}
.task-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}
.task-card:hover { border-color: var(--accent); transform: translateY(-1px); }
.task-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px;
}
.task-priority {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    padding: 2px 6px; border-radius: 4px;
}
.priority-high { background: rgba(218,54,51,0.2); color: var(--danger); }
.priority-medium { background: rgba(210,153,34,0.2); color: var(--warning); }
.priority-low { background: rgba(35,134,54,0.2); color: var(--accent); }

.task-title { font-size: 13px; font-weight: 500; line-height: 1.4; margin-bottom: 8px; }
.task-meta {
    display: flex; gap: 12px;
    font-size: 11px; color: var(--text-secondary);
}
.empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--text-muted);
    font-size: 13px;
}

/* Activity Log */
.activity-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
}
.activity-list {
    max-height: 280px;
    overflow-y: auto;
}
.activity-item {
    display: flex; align-items: flex-start;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
}
.activity-item:last-child { border-bottom: none; }
.activity-icon {
    width: 20px; height: 20px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; flex-shrink: 0;
}
.activity-icon.success { background: rgba(35,134,54,0.2); color: var(--accent); }
.activity-icon.error { background: rgba(218,54,51,0.2); color: var(--danger); }
.activity-icon.warning { background: rgba(210,153,34,0.2); color: var(--warning); }
.activity-icon.info { background: rgba(88,166,255,0.2); color: var(--blue); }
.activity-content { flex: 1; }
.activity-msg { font-size: 13px; }
.activity-time { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* Footer */
.footer {
    text-align: center;
    padding: 24px 0;
    color: var(--text-muted);
    font-size: 12px;
    border-top: 1px solid var(--border);
    margin-top: 24px;
}
.connection-status { color: var(--accent); }

/* Job Source Badges */
.priority-linkedin { background: rgba(0,119,181,0.2); color: #0077b5; }
.priority-indeed { background: rgba(216,65,44,0.2); color: #f44336; }
.priority-company-website { background: rgba(139,92,246,0.2); color: #8b5cf6; }
.priority-referral { background: rgba(34,197,94,0.2); color: #22c55e; }
.priority-recruiter { background: rgba(245,158,11,0.2); color: #f59e0b; }
.priority-other { background: rgba(107,114,128,0.2); color: #6b7280; }
.task-meta { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo">AI</div>
                <div>
                    <div class="header-title">Agent Dashboard</div>
                </div>
            </div>
            <div class="live-badge">
                <span class="live-dot"></span>
                <span id="connectionText">Connecting...</span>
            </div>
        </header>

        <!-- STATUS PANEL -->
        <div class="status-grid">
            <div class="status-card">
                <div class="status-main">
                    <div class="status-circle idle" id="statusCircle">ü§ñ</div>
                    <div class="status-info">
                        <div class="status-label">Current Status</div>
                        <div class="status-task" id="currentTask">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="status-card">
                <div class="token-box" style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div class="token-value" id="dailyTokens">--</div>
                    <div class="token-label">Tokens Used Today</div>
                </div>
            </div>
        </div>

        <!-- KANBAN BOARD -->
        <div class="kanban-section">
            <div class="section-header">
                <div class="section-title">üìã Task Board</div>
            </div>
            <div class="kanban-board" id="kanbanBoard">
                <div class="kanban-column">
                    <div class="column-header">
                        üì• Backlog
                        <span class="column-count" id="count-backlog">0</span>
                    </div>
                    <div class="column-cards" id="col-backlog"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        üìù To Do
                        <span class="column-count" id="count-todo">0</span>
                    </div>
                    <div class="column-cards" id="col-todo"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        ‚ñ∂Ô∏è In Progress
                        <span class="column-count" id="count-inprogress">0</span>
                    </div>
                    <div class="column-cards" id="col-inprogress"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        üëÄ Review
                        <span class="column-count" id="count-review">0</span>
                    </div>
                    <div class="column-cards" id="col-review"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        ‚úÖ Done
                        <span class="column-count" id="count-done">0</span>
                    </div>
                    <div class="column-cards" id="col-done"></div>
                </div>
            </div>
        </div>

        <!-- JOB APPLICATIONS KANBAN -->
        <div class="kanban-section" style="margin-top: 24px;">
            <div class="section-header">
                <div class="section-title">üíº Job Applications</div>
            </div>
            <div class="kanban-board" id="jobsKanban">
                <div class="kanban-column">
                    <div class="column-header">
                        üîç Not Applied
                        <span class="column-count" id="count-not-applied">0</span>
                    </div>
                    <div class="column-cards" id="col-not-applied"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        üìù CV Updated
                        <span class="column-count" id="count-cv-updated">0</span>
                    </div>
                    <div class="column-cards" id="col-cv-updated"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        üìÑ Filled
                        <span class="column-count" id="count-filled">0</span>
                    </div>
                    <div class="column-cards" id="col-filled"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        ‚è≥ Pending Approval
                        <span class="column-count" id="count-pending">0</span>
                    </div>
                    <div class="column-cards" id="col-pending"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        üì§ Submitted
                        <span class="column-count" id="count-submitted">0</span>
                    </div>
                    <div class="column-cards" id="col-submitted"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        ‚è±Ô∏è Response
                        <span class="column-count" id="count-response">0</span>
                    </div>
                    <div class="column-cards" id="col-response"></div>
                </div>
            </div>
        </div>

        <!-- ACTIVITY LOG -->
        <div class="activity-section">
            <div class="section-header">
                <div class="section-title">üìù Activity Log</div>
            </div>
            <div class="activity-list" id="activityList">
                <div class="empty-state">Loading...</div>
            </div>
        </div>

        <footer class="footer">
            <span class="connection-status" id="footerStatus">Connecting to Supabase...</span>
            <p style="margin-top: 8px;">Auto-refresh every 3 seconds</p>
        </footer>
    </div>

<script>
const CONFIG = {
    supabaseUrl: 'https://altmxznbmxidqirlarwh.supabase.co/rest/v1',
    supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsdG14em5ibXhpZHFpcmxhcndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzgxNTksImV4cCI6MjA4NTcxNDE1OX0.Sgl81tgqHI8S3ZzqbJYBa9jAl70HPa5b5_sCoGpDUJY',
    refreshInterval: 3000
};

let lastActivities = [];

const fetchData = async () => {
    try {
        const [statusRes, tasksRes, activityRes, jobsRes] = await Promise.all([
            fetch(`${CONFIG.supabaseUrl}/agent_status?select=*&id=eq.1`, {
                headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
            }),
            fetch(`${CONFIG.supabaseUrl}/agent_tasks?select=*&order=created_at.desc`, {
                headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
            }),
            fetch(`${CONFIG.supabaseUrl}/agent_activities?select=*&order=id.desc&limit=20`, {
                headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
            }),
            fetch(`${CONFIG.supabaseUrl}/job_applications?select=*&order=updated_at.desc`, {
                headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
            })
        ]);

        const status = statusRes.ok ? (await statusRes.json())[0] : null;
        const tasks = tasksRes.ok ? await tasksRes.json() : [];
        const activities = activityRes.ok ? await activityRes.json() : [];
        const jobs = jobsRes.ok ? await jobsRes.json() : [];

        updateUI(status, tasks, activities, jobs);
        setConnectionStatus(true);
    } catch (e) {
        console.error('Fetch error:', e);
        setConnectionStatus(false);
    }
};

const updateUI = (status, tasks, activities, jobs) => {
    // Status
    if (status) {
        const isWorking = status.status === 'working';
        document.getElementById('statusCircle').className = 'status-circle ' + (isWorking ? 'working' : 'idle');
        document.getElementById('statusCircle').textContent = isWorking ? '‚ö°' : 'ü§ñ';
        document.getElementById('currentTask').textContent = status.current_task || 'Idle';
        document.getElementById('dailyTokens').textContent = formatNum(status.tokens_daily || 0);
    }

    // Kanban
    const cols = { backlog: [], todo: [], inprogress: [], review: [], done: [] };
    (tasks || []).forEach(t => {
        const key = (t.task_status || 'backlog').replace('-', '');
        if (cols[key]) cols[key].push(t);
    });

    Object.entries(cols).forEach(([col, items]) => {
        const container = document.getElementById('col-' + col);
        const count = document.getElementById('count-' + col);
        if (container && count) {
            count.textContent = items.length;
            container.innerHTML = items.length === 0 
                ? '<div class="empty-state">No tasks</div>'
                : items.map(t => `
                    <div class="task-card" onclick="moveTask('${t.id}', '${t.task_status}')">
                        <div class="task-card-header">
                            <span class="task-priority priority-${t.task_priority}">${t.task_priority}</span>
                        </div>
                        <div class="task-title">${escapeHtml(t.task_title)}</div>
                        <div class="task-meta">
                            <span>‚ö° ${formatNum(t.task_tokens || 0)}</span>
                        </div>
                    </div>
                `).join('');
        }
    });

    // Job Applications
    if (jobs && jobs.length >= 0) {
        const jobCols = {
            'not-applied': jobs.filter(j => j.status === 'Not Applied'),
            'cv-updated': jobs.filter(j => j.status === 'CV Updated'),
            'filled': jobs.filter(j => j.status === 'Application Filled'),
            'pending': jobs.filter(j => j.status === 'Pending Approval'),
            'submitted': jobs.filter(j => j.status === 'Submitted'),
            'response': jobs.filter(j => ['Pending Response', 'Phone Screen', 'Interview', 'Offer', 'Rejected'].includes(j.status))
        };
        
        Object.entries(jobCols).forEach(([col, items]) => {
            const container = document.getElementById('col-' + col);
            const count = document.getElementById('count-' + col);
            if (container && count) {
                count.textContent = items.length;
                container.innerHTML = items.length === 0
                    ? '<div class="empty-state">No jobs</div>'
                    : items.map(j => `
                        <div class="task-card" onclick="moveJob('${j.id}', '${j.status}')">
                            <div class="task-card-header">
                                <span class="task-priority priority-${(j.source || 'other').toLowerCase().replace(/\s/g, '-')}">${j.source || 'Other'}</span>
                            </div>
                            <div class="task-title">${escapeHtml(j.job_title)}</div>
                            <div class="task-meta">${escapeHtml(j.company)}${j.cv_version ? ' ‚Ä¢ CV: ' + escapeHtml(j.cv_version) : ''}</div>
                        </div>
                    `).join('');
            }
        });
    }

    // Activities
    if (JSON.stringify(activities) !== JSON.stringify(lastActivities)) {
        lastActivities = activities;
        const list = document.getElementById('activityList');
        list.innerHTML = (activities || []).length === 0
            ? '<div class="empty-state">No activity yet</div>'
            : activities.map(a => `
                <div class="activity-item">
                    <div class="activity-icon ${a.type || 'info'}">${icon(a.type)}</div>
                    <div class="activity-content">
                        <div class="activity-msg">${escapeHtml(a.activity_message)}</div>
                        <div class="activity-time">${a.activity_time || '--:--'}</div>
                    </div>
                </div>
            `).join('');
    }
};

const moveTask = async (taskId, currentStatus) => {
    const flow = ['backlog', 'todo', 'in-progress', 'review', 'done'];
    const idx = flow.indexOf(currentStatus);
    const next = flow[(idx + 1) % flow.length];
    
    try {
        await fetch(`${CONFIG.supabaseUrl}/agent_tasks?id=eq.${taskId}`, {
            method: 'PATCH',
            headers: {
                'apikey': CONFIG.supabaseKey,
                'Authorization': `Bearer ${CONFIG.supabaseKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ task_status: next })
        });
        fetchData();
    } catch (e) {
        console.error('Move failed:', e);
    }
};

const moveJob = async (jobId, currentStatus) => {
    const flow = ['Not Applied', 'CV Updated', 'Application Filled', 'Pending Approval', 'Submitted', 'Pending Response'];
    const idx = flow.indexOf(currentStatus);
    if (idx === -1) return alert('Cannot cycle this status from dashboard. Use admin tools.');
    const next = flow[(idx + 1) % flow.length];
    
    try {
        await fetch(`${CONFIG.supabaseUrl}/job_applications?id=eq.${jobId}`, {
            method: 'PATCH',
            headers: {
                'apikey': CONFIG.supabaseKey,
                'Authorization': `Bearer ${CONFIG.supabaseKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: next, updated_at: new Date().toISOString() })
        });
        fetchData();
    } catch (e) {
        console.error('Job move failed:', e);
    }
};

const setConnectionStatus = (connected) => {
    const text = connected ? 'Live' : 'Disconnected';
    document.getElementById('connectionText').textContent = text;
    document.getElementById('footerStatus').textContent = connected 
        ? '‚óè Connected to Supabase' 
        : '‚óã Connection error';
    document.getElementById('footerStatus').style.color = connected ? 'var(--accent)' : 'var(--danger)';
};

const formatNum = (n) => {
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n/1000).toFixed(1) + 'K';
    return n.toString();
};

const escapeHtml = (text) => {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
};

const icon = (type) => {
    if (type === 'success') return '‚úì';
    if (type === 'error') return '‚úï';
    if (type === 'warning') return '!';
    return 'i';
};

// Init
fetchData();
setInterval(fetchData, CONFIG.refreshInterval);
</script>
</body>
</html>
